<!--
    TO-DO List
    - Initialize an empty array to store records /
    - Allow the user (via form input) to add at least 5 records
    - Operations
        - Add a record /
        - Delete a record with confirmation /
        - Update a record by searching for a unique field (class code)
        - Filter records by a meaningful rule (classes on Friday). /
        - Sort records by one numeric and one string field /
        - Write a custom search function that accepts partial keywords (typing "Ma" matches "Math 101"). 
        - Show results both in the console and in the DOM (HTML list or table).
    - Objects to define
        - student object { name, id, enrolledClasses: [] } /
        - class object { code, day, time } /
        - Methods: 
            - addClass(classObj) rejects if class conflicts in time. 
            - listClasses() returns all enrolled classes in readable format. /
    - UI Elements
        - Heading (<h2>) showing your chosen IS /
        - A form with at least 3 inputs for adding new records. /
        - Buttons: Add, Filter, Delete, Sort, Reset.  /
        - A container (<div id="list"></div>) to display records. / 
        - A summary section (<div id="summary"></div>) to show counts, totals, or reports. /
    - Functional Requirements
        - On Add, validate inputs, insert record into array, re-render list. 
        - On Filter, apply chosen filter and re-render. /
        - On Delete, confirm before removing record. /
        - On Sort, toggle ascending/descending. 
        - Implement live search with partial keywords. 
        - Highlight special cases in red (class after 6 PM). 
        - Provide a toggle view (table view vs. card view).
-->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>

    <h2>Schedule IS</h2>
    
    <form onsubmit="handleSubmit(event)">
        <input type="text" name="code" id="code" required>
        <input type="text" name="day" id="day" required>
        <input type="text" name="time" id="time" required>
        <button type="submit">Add</button>
    </form>

    <button onclick="filterClass()">Filter</button>
    <button onclick="deleteClass()">Delete</button>
    <button onclick="sortClass(true, true)">Sort</button>
    <button id="toggle_sort" onclick="toggleSort()" hidden>Toggle: Ascending</button>
    <button>Reset</button>

    <div id="list"></div>
    <div id="summary"></div>

    <script>
        // Object Literal
        const student = {
            name: "loki",
            id: "202",
            enrolled_classes: [new ClassObj("math 101", "monday", "7:30am-7:45am"), new ClassObj("math 102", "tuesday", "8:30am-9:30am"), new ClassObj("math 103", "monday", "6:30am-7:00am")],
            addClass: function(classObj) {
                this.enrolled_classes.push(classObj);
            },
            listClasses: function() {
                let class_str = "";
                for (let i=0; i < this.enrolled_classes.length; i++) {
                    class_str += `Class code: ${this.enrolled_classes[i].code}; Day: ${this.enrolled_classes[i].day}; Time: ${this.enrolled_classes[i].time}\n`;
                }
                return class_str;
            }
        };

        // Object contructor function for objects with arbitrary property values
        function ClassObj(code, day, time) {
            // Initialize object properties by paramater values
            this.code = code;
            this.day = day;
            this.time = time;
        }

        function handleSubmit(event) {
            event.preventDefault();

            let code = document.getElementById("code").value;
            let day = document.getElementById("day").value;
            let time = document.getElementById("time").value;

            student.addClass(new ClassObj(code, day, time));
            // Render list every submit
            renderList();
        }

        function renderList(filter_category = null, filter_value = null) {
            const listdiv = document.getElementById("list");

            // Clear previous content before rendering new content
            listdiv.innerHTML = "";

            // Get the class list string
            let class_str = student.listClasses();
            // Split by "\n" to separate each class information
            let class_str_arr = class_str.split("\n");


            for (let i=0; i < class_str_arr.length; i++) {
                let p = document.createElement("p");
                if (filter_category === "day") {
                    if (student.enrolled_classes[i].day == filter_value) {
                        p.textContent = class_str_arr[i];
                        listdiv.appendChild(p);
                    }
                } else if (filter_category === "time") {
                    if (student.enrolled_classes[i].time == filter_value) {
                        p.textContent = class_str_arr[i];
                        listdiv.appendChild(p);
                    }
                } else {
                    p.textContent = class_str_arr[i];
                    listdiv.appendChild(p);
                }
            }
        }

        renderList(); // for debugging

        function deleteClass() {
            let to_delete = prompt("Enter the code of the class you want to delete");
            let to_delete_found = false;
            
            let i=0;
            while (i < student.enrolled_classes.length) {
                if (to_delete === student.enrolled_classes[i].code) {
                    // A delete happen
                    to_delete_found = true;
                    // Stop the i from incrementing
                    break;
                }
                i++;
            }

            if (!to_delete_found) {
                alert("Class doesn't exist");
            } else {
                if (confirm("Are you sure you want to delete " + to_delete + "?")) {
                    // Remove the current element from array
                    student.enrolled_classes.splice(i, 1);
                    renderList();
                }
            }
        }

        function filterClass() {
            let category = prompt("Choose the category the filter will base from(day, time or all)").toLowerCase();

            if (!(category == "day" || category == "time" || category == "all")) {
                prompt("Invalid category");
            } else if (category == "all") {
                renderList();
            } else {
                let filter_value = prompt("Enter filter value");
                renderList(category, filter_value);
            }
        }

        function convertToMinutes(clock_format_string) {
            let letters = clock_format_string.replace(/[^apm]/g, "");
            let hour = parseInt(clock_format_string.slice(0, -5));
            let minutes = parseInt(clock_format_string.slice(0, -2).split(":")[1]);
            // Special condition: if 12am hours must be 0 and if 12pm should not add 720minutes (12 hrs)
            return ((letters == "am" && hour == 12) ? 0 : hour*60) + minutes + ((letters == "pm" && hour == 12) ? 0 : 720);
        }

        let sort_category;
        let isAscending = true;

        function toggleSort() {
            isAscending = (isAscending) ? false : true;
            sortClass(isAscending, false);

            document.getElementById("toggle_sort").innerText = isAscending ? "Toggle: Ascending" : "Toggle: Descending";
        }

        function sortClass(isAscending, withPrompt) {
            document.getElementById("toggle_sort").hidden = false;

            if (withPrompt) {
                sort_category = prompt("In what category do you want to sort");
            }

            if (sort_category == "day") {
                const dayOrder = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"];

                if (isAscending) {
                    student.enrolled_classes.sort((a, b) => {
                        return dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day);
                    });
                } else {
                    student.enrolled_classes.sort((a, b) => {
                        return dayOrder.indexOf(b.day) - dayOrder.indexOf(a.day);
                    });
                }

                renderList();
            } else if (sort_category == "time") {
                if (isAscending) {
                    student.enrolled_classes.sort((a, b) => {
                        return convertToMinutes(a.time.split("-")[0]) - convertToMinutes(b.time.split("-")[0]);
                    });
                } else {
                    student.enrolled_classes.sort((a, b) => {
                        return convertToMinutes(b.time.split("-")[0])- convertToMinutes(a.time.split("-")[0]);
                    });
                }

                renderList();
            }
        }
    </script>
</body>
</html>