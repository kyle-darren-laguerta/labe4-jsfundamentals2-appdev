<!--
    TO-DO List
    - Initialize an empty array to store records /
    - Allow the user (via form input) to add at least 5 records /
    - Operations
        - Add a record /
        - Delete a record with confirmation /
        - Update a record by searching for a unique field (class code) /
        - Filter records by a meaningful rule (classes on Friday). /
        - Sort records by one numeric and one string field /
        - Write a custom search function that accepts partial keywords (typing "Ma" matches "Math 101"). /
        - Show results both in the console and in the DOM (HTML list or table).
    - Objects to define
        - student object { name, id, enrolledClasses: [] } /
        - class object { code, day, time } /
        - Methods: 
            - addClass(classObj) rejects if class conflicts in time. /
            - listClasses() returns all enrolled classes in readable format. /
    - UI Elements
        - Heading (<h2>) showing your chosen IS /
        - A form with at least 3 inputs for adding new records. /
        - Buttons: Add, Filter, Delete, Sort, Reset.  /
        - A container (<div id="list"></div>) to display records. / 
        - A summary section (<div id="summary"></div>) to show counts, totals, or reports. /
    - Functional Requirements
        - On Add, validate inputs, insert record into array, re-render list. /
        - On Filter, apply chosen filter and re-render. /
        - On Delete, confirm before removing record. /
        - On Sort, toggle ascending/descending. /
        - Implement live search with partial keywords. /
        - Highlight special cases in red (class after 6 PM). /
        - Provide a toggle view (table view vs. card view). /
-->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>

    <h2>Schedule IS</h2>
    
    <form onsubmit="handleSubmit(event)">
        <input type="text" name="code" id="code" required>
        <input type="text" name="day" id="day" required>
        <input type="text" name="time" id="time" required>
        <button type="submit">Add</button>
    </form>

    <button id="filter_btn" onclick="filterClass()" hidden>Filter</button>
    <button id="delete_btn" onclick="deleteClass()" hidden>Delete</button>
    <button id="sort_btn" onclick="sortClass(true, true)" hidden>Sort</button>
    <button id="toggle_sort" onclick="toggleSort()" hidden>Toggle: Ascending</button>
    <button id="reset_btn" onclick="resetRecord()" hidden>Reset</button>

    <input type="text" id="search" placeholder="Search by class code" onkeyup="liveSearch()" hidden>
    <button id="update_btn" onclick="updateRecord()" hidden>Update</button>

    <div id="list"></div>
    <button id="toggle_view" onclick="toggleView()">Show Cards</button>
    <div id="summary"></div>

    <script>
        let view = "table"; // default view is table
        let class_to_be_updated;
        let sort_category;
        let isAscending = true;

        // Object Literal
        const student = {
            name: "Kyle Darren D. Laguerta",
            id: "2024-01-01840",
            enrolled_classes: [new ClassObj("math 101", "monday", "7:30am-7:45am"), new ClassObj("math 102", "tuesday", "8:30am-9:30am"), new ClassObj("math 103", "monday", "8:30am-9:30am"), new ClassObj("math 104", "wednesday", "8:30am-9:30am"), new ClassObj("math 105", "friday", "8:30am-9:30am")],
            addClass: function(classObj) {
                this.enrolled_classes.push(classObj);
            },
            listClasses: function() {
                let class_str = "";

                // Return a readable string of all enrolled classes
                for (let i=0; i < this.enrolled_classes.length; i++) {
                    class_str += `Class code: ${this.enrolled_classes[i].code}; Day: ${this.enrolled_classes[i].day}; Time: ${this.enrolled_classes[i].time}\n`;
                }
                return class_str;
            }
        };

        // Object contructor function for objects with arbitrary property values
        function ClassObj(code, day, time) {
            // Initialize object properties by paramater values
            this.code = code;
            this.day = day;
            this.time = time;
        }

        //----------------------------------------Validation Functions----------------------------------------//

        function validateCode(code) {
            // Check if the code already exist
            for (let i=0; i < student.enrolled_classes.length; i++) {
                if (student.enrolled_classes[i].code === code) {
                    return false;
                }
            }

            return true;
        }

        function validateDay(day) {
            const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"];

            // Check if the input day is a valid day
            return days.includes(day) ? true : false;
        }

        function validateTime(time) {
            // Split the time into start and end time
            let time_split = time.split("-");
            let time_valid = true;

            // Check if there are exactly 2 time intervals
            if (time_split.length !== 2) return false;
            
            for (let i=0; i < 2; i++) {
                // Extract the letters (am and pm), hour and minutes
                let letters = time_split[i].slice(-2);
                let hour = parseInt(time_split[i].slice(0, -5));
                let minutes = parseInt(time_split[i].slice(0, -2).split(":")[1]);
                time_valid &&= ((letters == "am" || letters == "pm") && (hour <= 12 && hour > 0) && (minutes < 60 && minutes >= 0));
            }
        
            // Check if time valid is true and the start time is less than the end
            return time_valid && (convertToMinutes(time_split[0]) < convertToMinutes(time_split[1]));
        }

        function validateSchedule(day, time) {
            let result = true;
            for (let i=0; i < student.enrolled_classes.length; i++) {
                // Check if the same day has conflicting time
                if (student.enrolled_classes[i].day === day) {
                    // Get the time intervals and convert it to minutes integer
                    let existing_time_start = convertToMinutes(student.enrolled_classes[i].time.split("-")[0]);
                    let existing_time_end = convertToMinutes(student.enrolled_classes[i].time.split("-")[1]);
                    let new_time_start = convertToMinutes(time.split("-")[0]);
                    let new_time_end = convertToMinutes(time.split("-")[1]);

                    // new_time_start must be less than existing_time_start or must be greater than or equal to existing_time_end
                    // new_time_end must be less than or equal to existing_time_start or must be greater than existing_time_end
                    result &&= (new_time_start < existing_time_start || new_time_start >= existing_time_end) && (new_time_end <= existing_time_start || new_time_end > existing_time_end);
                }
            }

            // Return true if day still not exist
            return result;
        }

        //----------------------------------------Main Functions----------------------------------------//

        function handleSubmit(event) {
            // Prevent from refreshing the page
            event.preventDefault();

            // Get the input values and validate them
            let code = document.getElementById("code").value.toLowerCase();
            if (validateCode(code)) {
                let day = document.getElementById("day").value.toLowerCase();
                if (validateDay(day)) {
                    let time = document.getElementById("time").value.toLowerCase();
                    if (validateTime(time)) {
                        if (validateSchedule(day, time)) {
                            // If all inputs are valid add the class
                            student.addClass(new ClassObj(code, day, time));

                            // Remind the user to input at least 5 records
                            if (student.enrolled_classes.length < 5) alert("Reminder: You must input at least 5 records before using other features.");

                            // Update the visibility of buttons
                            updateActionVisibility();

                            // Render list every successful submit
                            renderList();
                        } else {
                            alert("There is a conflict in the schedule");
                        }
                    } else {
                        alert("Invalid time");
                    }
                } else {
                    alert("Invalid day");
                }
            } else {
                alert("Class code already exist");
            }
        }

        function deleteClass() {
            let to_delete = prompt("Enter the code of the class you want to delete");
            let to_delete_found = false;
            
            let i=0;
            while (i < student.enrolled_classes.length) {
                if (to_delete === student.enrolled_classes[i].code) {
                    // A delete happen
                    to_delete_found = true;
                    // Stop the i from incrementing
                    break;
                }
                i++;
            }

            if (!to_delete_found) {
                alert("Class doesn't exist");
            } else {
                if (confirm("Are you sure you want to delete " + to_delete + "?")) {
                    // Remove the current element from array
                    student.enrolled_classes.splice(i, 1);
                    updateActionVisibility();
                    renderList();
                }
            }
        }

        function filterClass() {
            let category = prompt("Choose the category the filter will base from(day, time or no filter)").toLowerCase();

            if (category != "day" && category != "time" && category != "no filter") {
                alert("Invalid category");
            } else if (category == "no filter") {
                // No filter, just render the whole list
                renderList();
            } else {
                let filter_value = prompt("Enter filter value");
                // Put the category and value to the renderList function, renderList will handle the filtering
                renderList(category, filter_value);
            }
        }

        function resetRecord() {
            if (confirm("Are you sure you want to reset all records?")) {
                // Set the enrolled_classes to empty array
                student.enrolled_classes = [];
                renderList();
                // Call updateActionVisibility to hide buttons
                updateActionVisibility();
            }
        }

        function sortClass(isAscending, withPrompt) {
            // Unhide the toggle button for ascending/descending
            document.getElementById("toggle_sort").hidden = false;

            // This function is used by toggleSort that doesn't need a prompt
            if (withPrompt) {
                sort_category = prompt("In what category do you want to sort (day or time)");
            }

            if (sort_category == "day") {
                // Day order basis
                const dayOrder = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"];

                if (isAscending) {
                    student.enrolled_classes.sort((a, b) => {
                        return dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day);
                    });
                } else {
                    student.enrolled_classes.sort((a, b) => {
                        return dayOrder.indexOf(b.day) - dayOrder.indexOf(a.day);
                    });
                }

                renderList();
            } else if (sort_category == "time") {
                // Convert the time to minutes (integers) and sort based on start time
                if (isAscending) {
                    student.enrolled_classes.sort((a, b) => {
                        return convertToMinutes(a.time.split("-")[0]) - convertToMinutes(b.time.split("-")[0]);
                    });
                } else {
                    student.enrolled_classes.sort((a, b) => {
                        return convertToMinutes(b.time.split("-")[0])- convertToMinutes(a.time.split("-")[0]);
                    });
                }

                renderList();
            }
        }

        function toggleSort() {
            isAscending = (isAscending) ? false : true;
            sortClass(isAscending, false);

            document.getElementById("toggle_sort").innerText = isAscending ? "Toggle: Ascending" : "Toggle: Descending";
        }

        function toggleView() {
            if (view == "table") {
                view = "card";
                document.getElementById("toggle_view").innerText = "Show Table";
            } else {
                view = "table";
                document.getElementById("toggle_view").innerText = "Show Cards";
            }
            renderList();
        }

        function liveSearch() {
            // live search by partial class code
            const query = document.getElementById("search").value.toLowerCase();
            const listdiv = document.getElementById("list");

            // Clear before re-rendering
            listdiv.innerHTML = "";

            // Pass the query to renderList function, the renderList will handle the filtering
            renderList(null, null, query);

            for (let i=0; i < student.enrolled_classes.length; i++) {
                if(student.enrolled_classes[i].code === query) {
                    // Unhide the update button if there is a match
                    document.getElementById("update_btn").hidden = false;
                    class_to_be_updated = student.enrolled_classes[i];
                    break;
                } else {
                    document.getElementById("update_btn").hidden = true;
                }
            }
        }

        function updateRecord() {
            let update_category = prompt("What do you want to update (code, day, time, day and time)");
            let new_value;

            // For emptying input after successful modification
            let search_input = document.getElementById("search");

            if (update_category == "code") {
                new_value = prompt("Enter new code");
                // Check if the code already exist
                if (validateCode(new_value)) {                    
                    class_to_be_updated.code = new_value;
                    renderList();
                    search_input.value = "";
                } else {
                    alert("Code already exist");
                }
            } else if (update_category == "day") {
                new_value = prompt("Enter new day");
                // Check if the day is valid
                if (validateDay(new_value)) {
                    // Check of there is no conflicting schedule wihin the new day
                    if (validateSchedule(new_value, class_to_be_updated.time)) {
                        class_to_be_updated.day = new_value;
                        renderList();
                        search_input.value = "";
                    } else {
                        alert("There is a confict in the schedule");
                    }
                } else {
                    alert("Invalid day");
                }
            } else if (update_category == "time") {
                new_value = prompt("Enter new time");
                // Check if the time is valid
                if (validateTime(new_value)) {
                    // Check if the time doesn't conflict with exisiting time schedule
                    if (validateSchedule(class_to_be_updated.day, new_value)) {
                        class_to_be_updated.time = new_value;
                        renderList();
                        search_input.value = "";
                    } else {
                        alert("There is a confict in the schedule");
                    }
                } else {
                    alert("Invalid time");
                }
            } else if (update_category == "day and time") {
                // Update both at once for instances where updating one category will conflict with existing schedule
                let new_value_day = prompt("Enter new day");
                // Check if the day is valid
                if (validateDay(new_value_day)) {
                    let new_value_time = prompt("Enter new time");
                    // Check if the time is valid
                    if (validateTime(new_value_time)) {
                        // Check if the time doesn't conflict with exisiting time schedule
                        if (validateSchedule(new_value_day, new_value_time)) {
                            class_to_be_updated.day = new_value_day;
                            class_to_be_updated.time = new_value_time;
                            renderList();
                            search_input.value = "";
                        } else {
                            alert("There is a confict in the schedule");
                        }
                    } else {
                        alert("Invalid time");
                    }
                } else {
                    alert("Invalid day");
                }
            } else {
                alert("Invalid category");
            }
        }

        // ----------------------------------------Rendering Functions----------------------------------------//
        
        // The parameters is for filter purposes
        function renderList(filter_category = null, filter_value = null, live_input = null) {
            // Show the enrolled classes in the console
            console.log(student.listClasses());
            
            const listdiv = document.getElementById("list");

            // Clear previous content before rendering new content
            listdiv.innerHTML = "";

            // Applies for table view only
            // Table header must be created only once
            let table;
            if (view == "table") {
                // Create the table element
                table = document.createElement("table");
                table.border = "1"; // add border for visibility

                listdiv.appendChild(table);

                // Create table header
                const theadrow = document.createElement("tr");
                
                // Use try-catch to handle the case where there is no class
                try {
                    // Create headers based on object keys
                    const headers = Object.keys(student.enrolled_classes[0]);
                    headers.forEach(headerText => {
                        const theadcol = document.createElement("th");
                        theadcol.textContent = headerText;
                        theadrow.appendChild(theadcol);
                    });
                } catch (error) {
                    console.log("No classes to display");
                }

                table.appendChild(theadrow);
            }
            
            student.enrolled_classes.forEach(cls => {
                let showInfo = false;
                // Determine if the current class should be shown based on filter or live search
                if (filter_category === "day" && cls.day == filter_value) showInfo = true;
                else if (filter_category === "time" && cls.time == filter_value) showInfo = true;
                else if (live_input && cls.code.includes(live_input)) showInfo = true;
                else if (!live_input && !filter_category && !filter_value) showInfo = true;
                if (showInfo && view == "table") {
                    // If view is table create a new row for the current class
                    const trow = document.createElement("tr");
                    Object.values(cls).forEach(vals => {
                        const items = document.createElement("td");
                        items.textContent = vals;
                        // Highlight in red if class start time or class end time is after 6 PM (1080 minutes)
                        items.style.color = (convertToMinutes(cls.time.split("-")[0]) >= 1080 || convertToMinutes(cls.time.split("-")[1]) >= 1080) ? "red" : "black";
                        trow.appendChild(items);
                    });
                    table.appendChild(trow);
                } else if (showInfo && view == "card") {
                    // Create card container
                    const card = document.createElement("div");
                    card.style.border = "1px solid black";
                    card.style.padding = "10px";
                    card.style.margin = "10px";
                    card.style.display = "inline-block";

                    // Add card content
                    const code = document.createElement("h3");
                    code.textContent = cls.code;

                    const day = document.createElement("p");
                    day.textContent = "Day: " + cls.day;

                    const time = document.createElement("p");
                    time.textContent = "Time: " + cls.time;
                    time.style.color = (convertToMinutes(cls.time.split("-")[0]) >= 1080 || 
                                        convertToMinutes(cls.time.split("-")[1]) >= 1080) 
                                        ? "red" : "black";

                    // Append items to card
                    card.appendChild(code);
                    card.appendChild(day);
                    card.appendChild(time);

                    // Append card to list
                    listdiv.appendChild(card);
                }
            });

            // Display summary after rendering the list
            displaySummary();
        }

        function displaySummary() {
            let mondayCount = 0;
            let tuesdayCount = 0;
            let wednesdayCount = 0;
            let thursdayCount = 0;
            let fridayCount = 0;
            let saturdayCount = 0;
            let sundayCount = 0;
            let morningCount = 0;
            let afternoonCount = 0;
            let hybridCount = 0;

            student.enrolled_classes.forEach(cls => {
                // Incement the day count variable based on the day of the class
                if (cls.day === "monday") mondayCount++;
                if (cls.day === "tuesday") tuesdayCount++;
                if (cls.day === "wednesday") wednesdayCount++;
                if (cls.day === "thursday") thursdayCount++;
                if (cls.day === "friday") fridayCount++;
                if (cls.day === "saturday") saturdayCount++;
                if (cls.day === "sunday") sundayCount++;

                let start = cls.time.split("-")[0];
                let end = cls.time.split("-")[1];

                // Determine if the class is morning, afternoon or hybrid by checking the am/pm in the time string
                let isMorning = start.slice(-2) === "am" && end.slice(-2) === "am";
                let isAfternoon = start.slice(-2) === "pm" && end.slice(-2) === "pm";
                let isHybrid = start.slice(-2) === "am" && end.slice(-2) === "pm";
                if (isMorning) morningCount++;
                else if (isAfternoon) afternoonCount++;
                else if (isHybrid) hybridCount++;
            });

            const summaryDiv = document.getElementById("summary");
            summaryDiv.innerHTML =
                `<strong>Summary:</strong><br>` +
                `Classes on Monday: ${mondayCount}<br>` +
                `Classes on Tuesday: ${tuesdayCount}<br>` +
                `Classes on Wednesday: ${wednesdayCount}<br>` +
                `Classes on Thursday: ${thursdayCount}<br>` +
                `Classes on Friday: ${fridayCount}<br>` +
                `Classes on Saturday: ${saturdayCount}<br>` +
                `Classes on Sunday: ${sundayCount}<br>` +
                `Morning classes: ${morningCount}<br>` +
                `Afternoon classes: ${afternoonCount}<br>` +
                `Hybrid (morning to afternoon): ${hybridCount}`;
        }

        function updateActionVisibility() {
            // Hide if the enrolled_classes is less than 5
            // Show if the enrolled_classes is greater than or equal to 5
            const show = student.enrolled_classes.length >= 5;
            document.getElementById('filter_btn').hidden = !show;
            document.getElementById('delete_btn').hidden = !show;
            document.getElementById('sort_btn').hidden = !show;
            document.getElementById('search').hidden = !show;
            document.getElementById('reset_btn').hidden = !show;
        }

        //----------------------------------------Helper Functions----------------------------------------//

        function convertToMinutes(clock_format_string) {
            // Extract the letters (am and pm), hour and minutes
            let letters = clock_format_string.replace(/[^apm]/g, "");
            // Extract hour and minutes and convert to integer
            let hour = parseInt(clock_format_string.slice(0, -5));
            let minutes = parseInt(clock_format_string.slice(0, -2).split(":")[1]);
            // Special condition: if 12am hours must be 0 and if 12pm should not add 720minutes (12 hrs)
            return ((letters == "am" && hour == 12) ? 0 : hour*60) + minutes + ((letters == "pm" && hour == 12) || (letters == "am") ? 0 : 720);
        }

    </script>
</body>
</html>
